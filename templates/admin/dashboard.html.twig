{% extends 'base.html.twig' %}

{% block title %}Tableau de bord administrateur | EduTest{% endblock %}

{% block stylesheets %}
  {{ parent() }}
  <style>
    .admin-layout {
      min-height: calc(100vh - 80px);
      padding-top: 1.5rem;
      padding-bottom: 1.5rem;
    }

    /* Cartes statistiques */
    .admin-stat-card {
      border-radius: 1.1rem;
      border: 1px solid #e5e7eb;
    }

    .admin-stat-icon {
      width: 40px;
      height: 40px;
      border-radius: 999px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.3rem;
      background: #eff4ff;
    }

    .admin-stat-title {
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    /* Cartes génériques */
    .card {
      border-radius: 1.1rem;
      transition: all 0.2s ease-in-out;
    }

    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(15, 23, 42, 0.08);
    }

    .table thead th {
      background-color: #f8fafc;
    }

    .section-title {
      font-size: 0.95rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: #6b7280;
    }
    .chart-small {
      height: 220px;               /* Hauteur fixe propre */
      display: flex;
      align-items: center;
    }

  </style>
{% endblock %}

{% block body %}
<div class="container-xl admin-layout">
  <main>

    {# ========================== HEADER ========================== #}
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-4">
      <div>
        <div class="section-title mb-1">Administration</div>
        <h1 class="h2 fw-bold text-primary mb-1">Tableau de bord</h1>
        <p class="text-muted small mb-0">
          Vue d’ensemble des utilisateurs, examens et résultats de la plateforme.
        </p>
      </div>
      <div class="text-muted small mt-3 mt-md-0">
        Dernière mise à jour :
        <strong>{{ "now"|date("d/m/Y H:i") }}</strong>
      </div>
    </div>

    {# ========================== STATISTIQUES ========================== #}
    <div class="row g-3 mb-4">
      <div class="col-md-3 col-sm-6">
        <div class="card shadow-sm border-0 p-3 h-100 admin-stat-card">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <div class="admin-stat-icon text-primary">
              <i class="bi bi-person-video3"></i>
            </div>
          </div>
          <div class="admin-stat-title text-muted mb-1">Enseignants</div>
          <div class="h4 fw-bold mb-0">{{ totalTeachers|default(0) }}</div>
        </div>
      </div>

      <div class="col-md-3 col-sm-6">
        <div class="card shadow-sm border-0 p-3 h-100 admin-stat-card">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <div class="admin-stat-icon text-success">
              <i class="bi bi-mortarboard-fill"></i>
            </div>
          </div>
          <div class="admin-stat-title text-muted mb-1">Étudiants</div>
          <div class="h4 fw-bold mb-0">{{ totalStudents|default(0) }}</div>
        </div>
      </div>

      <div class="col-md-3 col-sm-6">
        <div class="card shadow-sm border-0 p-3 h-100 admin-stat-card">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <div class="admin-stat-icon text-info">
              <i class="bi bi-file-earmark-text"></i>
            </div>
          </div>
          <div class="admin-stat-title text-muted mb-1">Examens créés</div>
          <div class="h4 fw-bold mb-0">{{ totalExams|default(0) }}</div>
        </div>
      </div>

      <div class="col-md-3 col-sm-6">
        <div class="card shadow-sm border-0 p-3 h-100 admin-stat-card">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <div class="admin-stat-icon text-warning">
              <i class="bi bi-clipboard-data"></i>
            </div>
          </div>
          <div class="admin-stat-title text-muted mb-1">Taux de soumission</div>
          <div class="h4 fw-bold mb-0">{{ submissionRate|default(0) }}%</div>
        </div>
      </div>
    </div>

   {# ========================== GRAPHIQUES ========================== #}
<div class="row g-3 mb-4">

  {# Donut à gauche #}
  <div class="col-md-4 col-lg-3">
    <div class="card shadow-sm border-0 p-3 h-100">
      <h6 class="mb-3 text-primary d-flex align-items-center">
        <i class="bi bi-pie-chart-fill me-2"></i>
        Taux de soumission
      </h6>
      <canvas id="submissionChart" height="180"></canvas>
    </div>
  </div>

  {# Barres à droite #}
  <div class="col-md-8 col-lg-9">
    <div class="card shadow-sm border-0 p-3 h-100 chart-small">
      <h6 class="mb-3 d-flex align-items-center">
        <i class="bi bi-bar-chart-line me-2 text-primary"></i>
        Vue d’ensemble (volumes)
      </h6>
      <canvas id="adminStatsChart" height="80"></canvas>
    </div>
  </div>

</div>




    {# ========================== AJOUT UTILISATEUR + LISTES ========================== #}
    <section id="users-section" class="mb-4">
      <div class="card shadow-sm border-0 mb-4">
        <div class="card-header bg-white border-0 d-flex align-items-center">
          <h5 class="mb-0">
            <i class="bi bi-person-plus me-2 text-primary"></i>
            Ajouter un utilisateur
          </h5>
        </div>
        <div class="card-body">
          <form method="post" class="row g-3">
            <div class="col-md-4">
              <label class="form-label">Nom complet</label>
              <input type="text" name="fullName" class="form-control" placeholder="Ex: Jean Dupont" required>
            </div>
            <div class="col-md-4">
              <label class="form-label">Email</label>
              <input type="email" name="email" class="form-control" placeholder="exemple@domain.fr" required>
            </div>
            <div class="col-md-4">
              <label class="form-label">Mot de passe</label>
              <input type="password" name="password" class="form-control" placeholder="********" required>
            </div>
            <div class="col-md-4">
              <label class="form-label">Rôle</label>
              <select name="role" class="form-select" required>
                <option value="ROLE_TEACHER">Enseignant</option>
                <option value="ROLE_STUDENT">Étudiant</option>
              </select>
            </div>
            <div class="col-md-12 text-end">
              <button type="submit" class="btn btn-success px-4">
                <i class="bi bi-check-circle me-1"></i> Créer l’utilisateur
              </button>
            </div>
          </form>
        </div>
      </div>

      <div class="row">
        {# Enseignants #}
        <div class="col-lg-6 mb-4">
          <div class="card shadow-sm border-0 h-100">
            <div class="card-header bg-white border-0 d-flex align-items-center">
              <h5 class="mb-0">
                <i class="bi bi-person-video3 me-2 text-primary"></i>
                Enseignants
              </h5>
            </div>
            <div class="card-body table-responsive">
              <table class="table table-hover align-middle">
                <thead>
                  <tr><th>Nom</th><th>Email</th><th>Approuvé</th><th>Actions</th></tr>
                </thead>
                <tbody>
                {% for teacher in teachers %}
                  <tr>
                    <td>{{ teacher.fullName }}</td>
                    <td>{{ teacher.email }}</td>
                    <td>
                      {% if teacher.isApproved %}
                        <span class="badge bg-success">Oui</span>
                      {% else %}
                        <span class="badge bg-warning text-dark">Non</span>
                      {% endif %}
                    </td>
                    <td>
                      {% if not teacher.isApproved %}
                        <a href="{{ path('admin_approve_user', {id: teacher.id}) }}" class="btn btn-sm btn-success me-2">
                          <i class="bi bi-check-circle me-1"></i> Approuver
                        </a>
                      {% else %}
                        <a href="{{ path('admin_ban_user', {id: teacher.id}) }}" class="btn btn-sm btn-outline-warning me-2">
                          <i class="bi bi-slash-circle me-1"></i> Désactiver
                        </a>
                      {% endif %}
                      <a href="{{ path('admin_delete_user', {id: teacher.id}) }}" class="btn btn-sm btn-outline-danger">
                        <i class="bi bi-trash me-1"></i> Supprimer
                      </a>
                    </td>
                  </tr>
                {% else %}
                  <tr><td colspan="4" class="text-center text-muted">Aucun enseignant trouvé.</td></tr>
                {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>

        {# Étudiants #}
        <div class="col-lg-6 mb-4">
          <div class="card shadow-sm border-0 h-100">
            <div class="card-header bg-white border-0 d-flex align-items-center">
              <h5 class="mb-0">
                <i class="bi bi-mortarboard-fill me-2 text-success"></i>
                Étudiants
              </h5>
            </div>
            <div class="card-body table-responsive">
              <table class="table table-hover align-middle">
                <thead>
                  <tr><th>Nom</th><th>Email</th><th>Approuvé</th><th>Actions</th></tr>
                </thead>
                <tbody>
                {% for student in students %}
                  <tr>
                    <td>{{ student.fullName }}</td>
                    <td>{{ student.email }}</td>
                    <td>
                      {% if student.isApproved %}
                        <span class="badge bg-success">Oui</span>
                      {% else %}
                        <span class="badge bg-warning text-dark">Non</span>
                      {% endif %}
                    </td>
                    <td>
                      {% if not student.isApproved %}
                        <a href="{{ path('admin_approve_user', {id: student.id}) }}" class="btn btn-sm btn-success me-2">
                          <i class="bi bi-check-circle me-1"></i> Approuver
                        </a>
                      {% else %}
                        <a href="{{ path('admin_ban_user', {id: student.id}) }}" class="btn btn-sm btn-outline-warning me-2">
                          <i class="bi bi-slash-circle me-1"></i> Désactiver
                        </a>
                      {% endif %}
                      <a href="{{ path('admin_delete_user', {id: student.id}) }}" class="btn btn-sm btn-outline-danger">
                        <i class="bi bi-trash me-1"></i> Supprimer
                      </a>
                    </td>
                  </tr>
                {% else %}
                  <tr><td colspan="4" class="text-center text-muted">Aucun étudiant trouvé.</td></tr>
                {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </section>

    {# ========================== EXAMENS ========================== #}
    <section id="exams-section">
      <div class="card shadow-sm border-0">
        <div class="card-header bg-white border-0 d-flex justify-content-between align-items-center">
          <h5 class="mb-0">
            <i class="bi bi-journal-check me-2 text-info"></i>
            Examens
          </h5>
          <a href="{{ path('app_exam_index') }}" class="btn btn-outline-primary btn-sm fw-semibold">
            Voir tous les examens
          </a>
        </div>
        <div class="card-body">
          {% if exams is defined and exams|length > 0 %}
            <div class="table-responsive">
              <table class="table table-hover align-middle">
                <thead>
                  <tr><th>Titre</th><th>Description</th><th>Durée</th><th class="text-center">Actions</th></tr>
                </thead>
                <tbody>
                {% for exam in exams %}
                  <tr>
                    <td>{{ exam.title }}</td>
                    <td>{{ exam.description|default('—') }}</td>
                    <td>{{ exam.durationMinutes }} min</td>
                    <td class="text-center">
                      <a href="{{ path('admin_exam_export_pdf', {id: exam.id}) }}" class="btn btn-sm btn-outline-danger">
                        <i class="bi bi-filetype-pdf"></i> PDF
                      </a>
                      <a href="{{ path('admin_exam_export_csv', {id: exam.id}) }}" class="btn btn-sm btn-outline-success">
                        <i class="bi bi-filetype-csv"></i> CSV
                      </a>
                    </td>
                  </tr>
                {% endfor %}
                </tbody>
              </table>
            </div>
          {% else %}
            <p class="text-center text-muted mb-0">Aucun examen trouvé.</p>
          {% endif %}
        </div>
      </div>
    </section>

  </main>
</div>
{% endblock %}

{% block javascripts %}
  {{ parent() }}
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      // --- Donut : taux de soumission ---
      const ctxSubmission = document.getElementById('submissionChart');
      if (ctxSubmission) {
        const submitted = {{ submissionRate|default(0) }};
        const notSubmitted = Math.max(0, 100 - submitted);

        new Chart(ctxSubmission, {
          type: 'doughnut',
          data: {
            labels: ['Soumis', 'Non soumis'],
            datasets: [{
              data: [submitted, notSubmitted],
              backgroundColor: ['#16a34a', '#e5e7eb'],
              hoverOffset: 4
            }]
          },
          options: {
            plugins: {
              legend: {
                position: 'bottom',
                labels: {
                  boxWidth: 12,
                  font: { size: 11 }
                }
              }
            },
            cutout: '60%'
          }
        });
      }


      // --- Barres : volumes globaux ---
      const ctxStats = document.getElementById('adminStatsChart');
      if (ctxStats) {
        new Chart(ctxStats, {
          type: 'bar',
          data: {
            labels: ['Enseignants', 'Étudiants', 'Examens'],
            datasets: [{
              data: [
                {{ totalTeachers|default(0) }},
                {{ totalStudents|default(0) }},
                {{ totalExams|default(0) }}
              ],
              backgroundColor: ['#2563eb', '#16a34a', '#0ea5e9'],
              borderRadius: 6
            }]
          },
          options: {
            plugins: { legend: { display: false } },
            scales: {
              y: {
                beginAtZero: true,
                ticks: { stepSize: 1 }
              }
            }
          }
        });
      }
    });
  </script>
{% endblock %}


