{% extends 'base.html.twig' %}

{% block title %}üß† Passer l'examen | {{ exam.title }}{% endblock %}

{% block body %}
<div class="container py-5">
    <div class="text-center mb-4">
        <h1 class="text-primary fw-bold">{{ exam.title }}</h1>
        <p class="text-muted mb-1">
            ‚è±Ô∏è Dur√©e : {{ exam.durationMinutes }} min |
            Fin pr√©vue √† {{ deadline }}
        </p>
        <div id="countdown" class="fs-5 fw-semibold text-danger"></div>
    </div>

    <form method="post" action="{{ path('student_exam_submit', {'id': assignment.id}) }}">
        {% for question in questions %}
            <div class="card shadow-sm mb-4 border-0">
                <div class="card-body">
                    <h5 class="fw-bold mb-3">
                        {{ loop.index }}. {{ question.text }}
                    </h5>
                    <p class="text-muted small mb-3">
                        ({{ question.points }} point{{ question.points > 1 ? 's' : '' }})
                    </p>

                    {% if question.type == 'QCM' %}
                        <div class="row g-3">
                            {% for choice in question.choices %}
                                <div class="col-md-6">
                                    <label class="choice-card w-100 p-3 d-flex align-items-center border rounded-3 shadow-sm">
                                        <input type="checkbox"
                                               name="answers[{{ question.id }}][]"
                                               value="{{ choice.id }}"
                                               class="choice-input me-2"
                                               data-question="{{ question.id }}">
                                        <span class="choice-text">{{ choice.label }}</span>
                                    </label>
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <textarea class="form-control"
                                  name="answers[{{ question.id }}][text]"
                                  rows="3"
                                  placeholder="Votre r√©ponse ici..."
                                  data-question="{{ question.id }}"></textarea>
                    {% endif %}
                </div>
            </div>
        {% endfor %}

        <div class="text-center mt-4">
            <button id="submitButton" type="submit" class="btn btn-success btn-lg px-5">
                ‚úÖ Soumettre mes r√©ponses
            </button>
        </div>
    </form>
</div>

{% block stylesheets %}
<style>
.choice-card {
    cursor: pointer;
    transition: all 0.2s ease-in-out;
    background-color: #ffffff;
}
.choice-card:hover {
    background-color: #f0f7ff;
    border-color: #0d6efd;
}
.choice-input {
    position: absolute;
    opacity: 0; /* toujours accessible mais invisible */
}
.choice-card.active {
    background-color: #e7f1ff !important;
    border: 2px solid #0d6efd !important;
    border-radius: 8px;
    font-weight: 600;
    color: #0d6efd;
}
.choice-text {
    width: 100%;
}
#countdown {
    color: #dc3545;
}
</style>
{% endblock %}

{% block javascripts %}
<script>
// =============================
// üïí Compte √† rebours
// =============================
const deadline = new Date("{{ deadline|e('js') }}").getTime();
const countdownEl = document.getElementById("countdown");
const form = document.querySelector("form");

if (deadline > new Date().getTime() + 1000) {
    const timer = setInterval(() => {
        const now = new Date().getTime();
        const distance = deadline - now;

        if (distance <= 0) {
            clearInterval(timer);
            countdownEl.textContent = "‚è∞ Temps √©coul√© !";
            if (!form.dataset.submitted) {
                form.dataset.submitted = "true";
                form.submit();
            }
            return;
        }

        const minutes = Math.floor((distance / (1000 * 60)) % 60);
        const seconds = Math.floor((distance / 1000) % 60);
        countdownEl.textContent = `Temps restant : ${minutes} min ${seconds < 10 ? '0' + seconds : seconds} s`;
    }, 1000);
}

// =============================
// üíæ Sauvegarde + coloration imm√©diate
// =============================
const storageKey = "exam_answers_{{ assignment.id }}";
const saved = JSON.parse(localStorage.getItem(storageKey) || "{}");

// üîÑ Restaurer
document.querySelectorAll('.choice-input').forEach(input => {
    const qid = input.dataset.question;
    if (saved[qid] && saved[qid].includes(input.value)) {
        input.checked = true;
        input.closest('.choice-card').classList.add('active');
    }
});

// üé® G√©rer la couleur d√®s le clic
document.querySelectorAll('.choice-card').forEach(card => {
    const input = card.querySelector('.choice-input');
    card.addEventListener('click', (e) => {
        // √âvite double bascule
        e.preventDefault();
        input.checked = !input.checked;
        card.classList.toggle('active', input.checked);

        const qid = input.dataset.question;
        saved[qid] = saved[qid] || [];
        if (input.checked) {
            if (!saved[qid].includes(input.value)) saved[qid].push(input.value);
        } else {
            saved[qid] = saved[qid].filter(v => v !== input.value);
        }
        localStorage.setItem(storageKey, JSON.stringify(saved));
    });
});

// üî§ Sauvegarde texte
document.querySelectorAll('textarea').forEach(area => {
    const qid = area.dataset.question;
    if (saved[qid]) area.value = saved[qid];
    area.addEventListener('input', () => {
        saved[qid] = area.value;
        localStorage.setItem(storageKey, JSON.stringify(saved));
    });
});

// üßπ Nettoyage √† la soumission
form.addEventListener('submit', () => {
    localStorage.removeItem(storageKey);
});
</script>
{% endblock %}
{% endblock %}
