{% extends 'base.html.twig' %}
{% block title %}Passer l'examen | {{ exam.title }}{% endblock %}

{% block body %}
<div class="container exam-run-container py-5" style="max-width: 900px;">

    <!-- En-tête Examen -->
    <div class="text-center mb-5">
        <h1 class="text-primary fw-bold">{{ exam.title }}</h1>

        <p class="text-muted mt-2">
            ⏱️ Durée : <strong>{{ exam.durationMinutes }} min</strong> · 
            Fin prévue à <strong>{{ deadline|date('d/m/Y H:i') }}</strong>
        </p>

        <div id="countdown" class="countdown-pill mt-3">
            ⏳ Chargement du temps restant...
        </div>
    </div>

    <!-- FORM -->
    <form method="post" action="{{ path('student_exam_submit', {'id': assignment.id}) }}">
        {% for question in questions %}
            <div class="card border-0 shadow-sm p-4 mb-4 question-card">
                <h5 class="fw-bold mb-2">
                    {{ loop.index }}. {{ question.text }}
                </h5>

                <p class="small text-muted mb-3">
                    ({{ question.points }} point{{ question.points > 1 ? 's' : '' }})
                </p>

                {% if question.type == 'QCM' %}
                    <div class="row gy-3">
                        {% for choice in question.choices %}
                            <div class="col-md-6">
                                <label class="choice-card shadow-sm">
                                    <input type="checkbox"
                                           name="answers[{{ question.id }}][]"
                                           value="{{ choice.id }}"
                                           class="choice-input"
                                           data-question="{{ question.id }}">

                                    <span class="choice-text">{{ choice.label }}</span>
                                </label>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <textarea class="form-control answer-textarea"
                              name="answers[{{ question.id }}][text]"
                              rows="3"
                              placeholder="Votre réponse ici..."
                              data-question="{{ question.id }}"></textarea>
                {% endif %}
            </div>
        {% endfor %}

        <div class="text-center mt-4">
            <button id="submitButton" type="submit" class="btn btn-success btn-lg px-5 shadow-sm">
                Soumettre mes réponses
            </button>
        </div>
    </form>

</div>
{% endblock %}

{% block stylesheets %}
<style>
/* Timer */
.countdown-pill {
    display: inline-block;
    padding: 8px 16px;
    background: #ffe3e3;
    color: #b30000;
    border: 1px solid #ffb3b3;
    border-radius: 30px;
    font-size: 1.1rem;
    font-weight: 600;
}

/* Card questions */
.question-card {
    border-radius: 14px;
}

/* Cards des choix */
.choice-card {
    cursor: pointer;
    padding: 14px 16px;
    border-radius: 10px;
    border: 1px solid #e2e6ea;
    background: white;
    display: flex;
    align-items: center;
    gap: 12px;
    transition: all 0.25s ease-in-out;
    position: relative;
}
.choice-card:hover {
    background: #f0f6ff;
    border-color: #0d6efd;
}

.choice-input {
    position: absolute;
    opacity: 0;
}

.choice-card.active {
    background: #e6f0ff;
    border: 2px solid #0d6efd;
    color: #0d6efd;
}

.answer-textarea {
    border-radius: 10px;
}

/* Animation douce */
.choice-card,
.question-card {
    transition: transform .15s ease, box-shadow .2s ease;
}
.choice-card:hover {
    transform: translateY(-2px);
}
.exam-run-container {
    margin-top: 2.5rem; 
}

</style>
{% endblock %}

{% block javascripts %}
  {{ parent() }}
  <script>
    // === TIMER ===
    const deadline = new Date("{{ deadline|date('c') }}").getTime();
    const countdownEl = document.getElementById("countdown");
    const form = document.querySelector("form");

    if (deadline > Date.now()) {
        const timer = setInterval(() => {
            const now = Date.now();
            const distance = deadline - now;

            if (distance <= 0) {
                clearInterval(timer);
                countdownEl.textContent = "⛔ Temps écoulé !";
                countdownEl.style.background = "#ffb3b3";
                if (!form.dataset.submitted) {
                    form.dataset.submitted = "true";
                    form.submit();
                }
                return;
            }

            const m = Math.floor(distance / 60000);
            const s = Math.floor((distance % 60000) / 1000);
            countdownEl.textContent = `⏳ ${m} min ${s < 10 ? "0"+s : s}s restantes`;
        }, 1000);
    }

    // === SAUVEGARDE LOCALE ===
    const storageKey = "exam_answers_{{ assignment.id }}";
    const saved = JSON.parse(localStorage.getItem(storageKey) || "{}");

    // Restaurer QCM
    document.querySelectorAll('.choice-input').forEach(input => {
        const qid = input.dataset.question;
        if (saved[qid]?.includes(input.value)) {
            input.checked = true;
            input.closest('.choice-card').classList.add('active');
        }
    });

    // Toggle visuel + sauvegarde
    document.querySelectorAll('.choice-card').forEach(card => {
        const input = card.querySelector('.choice-input');

        card.addEventListener('click', e => {
            e.preventDefault();
            input.checked = !input.checked;
            card.classList.toggle('active', input.checked);

            const qid = input.dataset.question;
            saved[qid] ||= [];
            input.checked
                ? saved[qid].push(input.value)
                : saved[qid] = saved[qid].filter(v => v !== input.value);

            localStorage.setItem(storageKey, JSON.stringify(saved));
        });
    });

    // Restaurer les réponses texte
    document.querySelectorAll('textarea').forEach(area => {
        const qid = area.dataset.question;
        if (saved[qid]) area.value = saved[qid];
        area.addEventListener('input', () => {
            saved[qid] = area.value;
            localStorage.setItem(storageKey, JSON.stringify(saved));
        });
    });

    // Nettoyer à la soumission
    form.addEventListener('submit', () => localStorage.removeItem(storageKey));
</script>
{% endblock %}
